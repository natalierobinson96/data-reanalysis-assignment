---
title: "Data Reanalysis Assignment"
author: "Natalie Robinson"
date: "October 17, 2017"
output: html_document
---
# Female reproductive strategies in orangutans, evidence for female choice and counterstrategies to infanticide in a species with frequent sexual coercion
**Cheryl D Knott, Melissa Emery Thompson, Rebecca M Stumpf and Matthew H McIntyre**

The paper can be accessed [here](https://github.com/natalierobinson96/data-reanalysis-assignment/blob/master/Knott%202010%20Proc%20B%20Orangutan%20Sexual%20Coercion%20copy.pdf)

# Summary of Paper

  Orangutans have exceptionally high rates of forced copulations. Traditionally, it was assumed that this was a strategy used by unflanged males, who are sexually mature but have not developed secondary sexual characteristics like prime males who have large cheek flanges. Little thought was given to how female strategies may have shaped or responded to this behavior. Knott et al. (2010) found that male morph alone was not a good predictor of mating dynamics among wild Bornean orangutans (*Pongo pygmaeus wurmbii*), but rather female conception risk mediated the occurence of male-female interactions. 
  
```{r, echo = FALSE, out.width = "50%"}
library(knitr)
include_graphics("http://savegporangutans.org/wp-content/uploads/2013/08/MM8117_140711_35614-Version-2.jpg")
```
This is a flanged male orangutan named Codet.

```{r, echo = FALSE, out.width = "50%"}
library(knitr)
include_graphics("http://savegporangutans.org/wp-content/uploads/2013/07/MM8117_110717_01123-cropped_2.jpg")
```
This is an adult female, Delly, with her infant Duwyk.
  
  Knott et al. (2010) assayed urine samples and compared ovarian hormone profiles with the sexual behavior of females and males in order to understand the females' ovulatory cycles (as they do not have obvious sexual swellings). Behavioral data was collected from 1994-2003 at the Cabang Panti Research Site in Gunung Palung National Park, West Kalimantan, Indonesia. During the 45,500 hours of observation, 387 encounters occured between males and females. Of these, male and female reproductive status could be determined for 153 encounters. 21 matings (between 10 males and 7 females) were observed during these encounters. They found that females were more likely to mate cooperatively with prime flanged males near ovulation, while they were more willing to associate and mate with non-prime males when conception risk was low. 

![Bornean orangutans live in lowland rainforests.](http://savegporangutans.org/wp-content/uploads/2013/08/Lianas-in-the-jungle.jpg)  

(all photos are from the [Gunung Palung Conservation website](http://savegporangutans.org/orangutans/))

# Prerequisites
First, I loaded in the required packages.
```{r}
library(curl)
library(dplyr)
library(stats)
library(AICcmodavg)
library(MASS)
library(knitr)
```

# Obtaining the Data
I first recieved this data in various files of .sav format, as it had been exported from SPSS. I was able to open the files in R using the "foreign" package and the command read.spss, though I decided it would be easier to manipulate the data if it were in a .csv file, as I am more familiar with this.
I was able to do this online using [this website](http://pspp.benpfaff.org/) where you can upload a .sav file and then download the corresponding .csv file. The files are available in my Github repository titled "data-reanalysis-assignment." First, I loaded in the main csv file, which contains all of the compiled data.

```{r}
# getting the data into R
library(curl)
f <- curl("https://raw.githubusercontent.com/natalierobinson96/data-reanalysis-assignment/master/matings%20with%20endocrine%20data.csv")
d <- read.csv(f, header = TRUE, sep = ",")
head(d)
```

# Replication 1: Figure 1 (Descriptive)
First I replicated Figure 1 from the paper. This figure shows the distribution of matings with respect to male type and female ovulatory status.

First I created 3 variables of female mating type. Each female was either pregnant, in the periovulatory period, or neither (non-periovulatory).

```{r}
nonPOP <- filter(d, preg == "0" & POP == "0")
nonPOP #matings with females not in periovulatory period; currently cycling
```

```{r}
pregnant <- filter(d, preg == "1")
pregnant #matings with pregnant females 
```

```{r}
POP <- filter(d, POP == "1")
POP #matings with females in periovulatory period
```

(Note: when knitting the file I continued to get an error message in each chunk until I added "eval = FALSE" at the top of the chunk. I couldn't figure out why this was happening, so for each chunk I wanted to show the output of, I added a new chunk below it with the same output variable but "echo = FALSE" at the top. This allows just the output to be shown, without the code in the extra chunk.)

Next I created 6 more variables which will serve as each entry of the replicated bar plot. The 3 female ovulatory statuses stay the same, though they are divided bewtween those who mated with prime males and those who mated with non-prime males (either unflanged or past-prime).
For each variable I also counted the number of occurences of the type of mating by counting the number of rows.

```{r}
nonPOP_nonprime <- filter(nonPOP, prime == "0")
nonPOP_nonprime
totalmatings1 <- length(attributes(nonPOP_nonprime)$row.names)
```

```{r}
nonPOP_prime <- filter(nonPOP, prime == "1")
nonPOP_prime
totalmatings2 <- length(attributes(nonPOP_prime)$row.names)
```

```{r}
pregnant_nonprime <- filter(pregnant, prime == "0")
pregnant_nonprime
totalmatings3 <- length(attributes(pregnant_nonprime)$row.names)
```

```{r}
pregnant_prime <- filter(pregnant, prime == "1")
pregnant_prime
totalmatings4 <- length(attributes(pregnant_prime)$row.names)
```

```{r}
POP_nonprime <- filter(POP, prime == "0")
POP_nonprime
totalmatings5 <- length(attributes(POP_nonprime)$row.names)
```

```{r}
POP_prime <- filter(POP, prime == "1")
POP_prime
totalmatings6 <- length(attributes(POP_prime)$row.names)
```

I then created a vector of each of the values of occurences.
```{r}
v <- c(totalmatings1, totalmatings2, totalmatings3, totalmatings4, totalmatings5, totalmatings6)

barplot(v, main = "Figure 1", xlab = "female endocrine status", ylab = "mating events observed", names.arg = c("non-periovulatory","non-periovulatory","pregnant","pregnant", "periovulatory", "periovulatory"), col = "black", density = c(100, 0, 100, 0, 100, 0), space = c(1, 0, 1, 0, 1, 0))
```

This is what the original figure from the paper looked like:

<img src="img/Figure 1.pdf" width="500px"/>

They are the same!

It is possible that there is a more concise way to replicate this figure, though this way seemed the most logical to me, given the format of the data.

# Replication 2: Figure 2 (Descriptive)

The second figure in the paper shows the distribution of female encounters with males, with respect to male type and female ovulatory status. I planned to use a similar method to create this figure as I did for the first one (the dependent variable is now 'encounters observed'), though I ran into a lot of problems. 

I recieved this dataset from the professor who is first author on this paper. She did not have the original files, so she reached out to the author who ran all the statistics for the paper. He emailed her zipped folders of all of the old versions of the dataset that he had. She then forwarded these folders to me, which contained hundreds of different documents which spanned the course of nearly 3 years. Unfortunately, all the observation data was spread out between different files which led to confusion. Additionally, the same writing conventions were not used throughout all the daat. For example, some variables were recorded as full words like "Prime" and "Nonprime" , while others were recorded as binary numbers "0" and "1". 

To begin the second replication, I first converted another SPSS file into csv format and loaded it in to R. This file contains all 2460 orangutan follows.
```{r}
# getting the data into R
library(curl)
f2 <- curl("https://raw.githubusercontent.com/natalierobinson96/data-reanalysis-assignment/master/interactions.csv")
d2 <- read.csv(f2, header = TRUE, sep = ",")
head(d2)
```

Next I created a new dataframe which only includes the observation entries (in which a male and female interacted with each other) which were included in the final analysis (in which both male and female reproductive status were known):
```{r}
d2 <- filter(d2, InteractionwithMale == "Y")
d2 <- filter(d2, included == "1")
head(d2)
```

This contains 331 observations, however, the paper states that only 153 encounters were included in the analysis. I continued on anyway.

As before, I created the 3 categories of female endocrine status:
```{r}
nonPOP <- filter(d2, lact == "1")
head(nonPOP) #matings with females not in periovulatory period; currently cycling
```

```{r}
pregnant <- filter(d2, preg == "1")
head(pregnant) #matings with pregnant females 
```

```{r}
POP <- filter(d2, POP == "1")
head(POP) #matings with females in periovulatory period
```

I created 6 more variables which serve as each entry of the replicated bar plot. The 3 female ovulatory statuses stay the same, though they are divided bewtween those who encountered prime males and those who encountered non-prime males (either unflanged or past-prime).
For each variable I also counted the number of occurences of encounters by counting the number of rows. This is the same as what I did in the initial replication.

```{r}
nonPOP_nonprime <- filter(nonPOP, prime == "0")
totalmatings1 <- length(attributes(nonPOP_nonprime)$row.names)
```
```{r}
nonPOP_prime <- filter(nonPOP, prime == "1")
totalmatings2 <- length(attributes(nonPOP_prime)$row.names)
```
```{r}
pregnant_nonprime <- filter(pregnant, prime == "0")
totalmatings3 <- length(attributes(pregnant_nonprime)$row.names)
```
```{r}
pregnant_prime <- filter(pregnant, prime == "1")
totalmatings4 <- length(attributes(pregnant_prime)$row.names)
```
```{r}
POP_nonprime <- filter(POP, prime == "0")
totalmatings5 <- length(attributes(POP_nonprime)$row.names)
```
```{r}
POP_prime <- filter(POP, prime == "1")
totalmatings6 <- length(attributes(POP_prime)$row.names)
```

I then created a vector of each of the values of occurences.
```{r, eval = FALSE}
v2 <- c(totalmatings1, totalmatings2, totalmatings3, totalmatings4, totalmatings5, totalmatings6)

barplot(v2, main = "Figure 2", xlab = "female endocrine status", ylab = "encounters observed", names.arg = c("non-periovulatory","non-periovulatory","pregnant","pregnant", "periovulatory", "periovulatory"), col = "black", density = c(100, 0, 100, 0, 100, 0), space = c(1, 0, 1, 0, 1, 0))
```

This is what the figure from the paper looks like:

<img src="img/Figure 2.pdf" width="500px"/>

This replication did not turn out the same as the original figure. The "pregnant" and "periovulatory" categories look correct, though the values for the "non-periovulatory" category are too low. Unsure how to fix this, I tried using a different file, which contained a shortened version of the interaction data.

I loaded in the other converted file and created a new dataframe which only includes the observations which are in the final analysis:
```{r}
# getting the data into R
library(curl)
f2 <- curl("https://raw.githubusercontent.com/natalierobinson96/data-reanalysis-assignment/master/interactions%20(short).csv")
d2 <- read.csv(f2, header = TRUE, sep = ",")
d2 <- filter(d2, InteractionwithMale == "Y")
head(d2)
```

This file already had the interactions divided into columns of the 6 categories for the barplot, so I filtered these out. 
```{r}
nonPOP_nonprime <- filter(d2, nPOPnprime == "1")
totalmatings1 <- length(attributes(nonPOP_nonprime)$row.names)
```
```{r}
nonPOP_prime <- filter(d2, nPOPprime == "1")
totalmatings2 <- length(attributes(nonPOP_prime)$row.names)
```
```{r}
pregnant_nonprime <- filter(d2, CYCNprime == "1")
totalmatings3 <- length(attributes(pregnant_nonprime)$row.names)
```
```{r}
pregnant_prime <- filter(d2, CYCprime == "1")
totalmatings4 <- length(attributes(pregnant_prime)$row.names)
```
```{r}
POP_nonprime <- filter(d2, POPnprime == "1")
totalmatings5 <- length(attributes(POP_nonprime)$row.names)
```
```{r}
POP_prime <- filter(d2, POPprime == "1")
totalmatings6 <- length(attributes(POP_prime)$row.names)
```

I then created a vector of each of the values of occurences.
```{r}
v2 <- c(totalmatings1, totalmatings2, totalmatings3, totalmatings4, totalmatings5, totalmatings6)

barplot(v2, main = "Figure 2", xlab = "female endocrine status", ylab = "encounters observed", names.arg = c("non-periovulatory","non-periovulatory","pregnant","pregnant", "periovulatory", "periovulatory"), col = "black", density = c(100, 0, 100, 0, 100, 0), space = c(1, 0, 1, 0, 1, 0))
```

Here, the "periovulatory" columns remain correct, the "pregnant" columns are now too high, and the "non-periovulatory" columns remain incorrect. 

After trying more iterations of code with both of the files, I noticed a column titled "endomiss" in the original long version of the interactions file. This column is filled in for each interaciton observation with either a "0" or "1". My best guess is that this indicates whether or not the endocrine data from urine samples is missing or not. "0" would indicate that it is not missing (so the interaction can be used), while "1" would indicate that the endocrine data is missing, and should be excluded from the analysis. I added this into the filter of my original code to see if it would help me.

First, I loaded the original set of data in to R.
```{r}
library(curl)
f2 <- curl("https://raw.githubusercontent.com/natalierobinson96/data-reanalysis-assignment/master/interactions.csv")
d2 <- read.csv(f2, header = TRUE, sep = ",")
```

Next I created a new dataframe which only includes the observation entries which were included in the final analysis.
```{r}
d2 <- filter(d2, InteractionwithMale == "Y")
d2 <- filter(d2, included == "1")
d2 <- filter(d2, endomiss == "0")
head(d2) # I got it down to the 153 observations!!
```
Finally, this dataframe contains 153 rows -- the correct number of observations!

As before, I created the 3 categories of female endocrine status:
```{r}
nonPOP <- filter(d2, preg == "0" & POP == "0") #matings with females not in periovulatory period; currently cycling
```
```{r}
pregnant <- filter(d2, preg == "1") #matings with pregnant females 
```
```{r}
POP <- filter(d2, POP == "1") #matings with females in periovulatory period
```

Then I created 6 more variables which will serve as each entry of the replicated bar plot. The 3 female ovulatory statuses stay the same, though they are divided bewtween those who encountered prime males and those who encountered non-prime males (either unflanged or past-prime).
For each variable I also counted the number of occurences of encounters by counting the number of rows.

```{r}
nonPOP_nonprime <- filter(nonPOP, prime == "0")
totalmatings1 <- length(attributes(nonPOP_nonprime)$row.names)
```

```{r}
nonPOP_prime <- filter(nonPOP, prime == "1")
totalmatings2 <- length(attributes(nonPOP_prime)$row.names)
```

```{r}
pregnant_nonprime <- filter(pregnant, prime == "0")
totalmatings3 <- length(attributes(pregnant_nonprime)$row.names)
```

```{r}
pregnant_prime <- filter(pregnant, prime == "1")
totalmatings4 <- length(attributes(pregnant_prime)$row.names)
```

```{r}
POP_nonprime <- filter(POP, prime == "0")
totalmatings5 <- length(attributes(POP_nonprime)$row.names)
```

```{r}
POP_prime <- filter(POP, prime == "1")
totalmatings6 <- length(attributes(POP_prime)$row.names)
```

I then created a vector of each of the values of occurences.
```{r}
v2 <- c(totalmatings1, totalmatings2, totalmatings3, totalmatings4, totalmatings5, totalmatings6)

barplot(v2, main = "Figure 2", xlab = "female endocrine status", ylab = "encounters observed", names.arg = c("non-periovulatory","non-periovulatory","pregnant","pregnant", "periovulatory", "periovulatory"), col = "black", density = c(100, 0, 100, 0, 100, 0), space = c(1, 0, 1, 0, 1, 0))
```

Again, this is what the figure from the paper looks like:

<img src="img/Figure 2.pdf" width="500px"/>

They are the same!

Though the code for creating this graph is simple, the difficult part of replication was sorting through all the data that was sent to me. I was given separate spreadsheets (of various different formats) from different dates containing different data. This made it very difficult to figure out which data I should use for each part of the replication. This has taught me an important lesson for my own future research/data collection. A cleaner/simpler dataset allows less room for error in analysis and is overall more user-friendly. 

# Replication 3: Linear Mixed Model Analysis (Inferential)

  To make sense of this data, Knott et al. (2010) used a linear mixed model analysis. As explained in the paper, all random effects were intercept only and used female identity as the subject identifier. Male identity was not used to characterize non-independence because male inclusion in the observations was not under researcher control. Additionally, female reproductive status varies substantially more than the male-specific variable of prime vs. non-prime.  
  
  For binary outcomes (such as type of male encountered and the occurence of mating), mixed logistic models were used. The authors used the logit.mixed procedure in R, though this package is no longer available. Instead, I will use ___ for my replication. 
  
  For continuous outcomes (such as the number of resistant behaviors observed), the authors used mixed linear models. This was done in an SPSS program called MIXED. The same modelling was done for the association between male and female behavior during mating interactions, though log-transformed variables were used for analysis and were then returned to linear values for reporting of estimates. I will not try to replicate this portion of the modelling. 
  
## Model 1:   
  

family binomial --> logistic , link == "logit"


Questions to ask:
- how to imbed img (and have the others show up)
- why won't figures show up when I knit? Added eval = FALSE so it would knit, could this be why?